## Conway 生命游戏（MoonBit + WASM-4 版本）游戏说明

> 本文件用于参赛 / 展示提交的“游戏介绍（README 扩展版）”。仅在此文件中撰写，不修改仓库其它文件。

---

### 1. 游戏简介

**创作背景**  
Conway 的 Game of Life（生命游戏）是最经典的零玩家(Cellular Automaton)示例之一：只需要一组初始细胞配置，后续世界随规则自动演化，展示“简单规则 -> 复杂涌现”的魅力。本项目意在：

1. 演示 MoonBit 语言在 WASM-4 虚拟主机上的快速原型能力。  
2. 提供一个结构清晰、易阅读、可扩展的教学示例：将“数据表示 / 演化逻辑 / 渲染 / 输入”彻底拆分。  
3. 方便进一步添加：模式库、速度调节、统计信息、彩色可视化、模式探测等特性。

**玩法目标**  
生命游戏没有传统“通关”目标，玩家体验重点在：

- 通过放置初始细胞，观察图案是否稳定、振荡、移动或崩溃；
- 构造经典结构（滑翔机 Glider、脉冲星 Pulsar、Gosper 滑翔枪等）；
- 研究规则下的生存 / 死亡边界感；
- 以暂停 + 编辑 + 继续 的循环方式进行实验。

**设计理念**  
“模块化、纯逻辑、低耦合、清晰时序”。框架上坚持：

- 纯状态容器：`GameOfLife` 只关心网格与世代演化；
- 外层 `game_state` 管理运行标志、计数器与拖拽状态；
- `simulation` 负责节流（以 fixed tick 控制演化帧率）；
- `input_handler`专注输入映射（手柄 / 鼠标）；
- `renderer` 纯渲染（背景 / 网格 / 活细胞 / 悬停反馈）。

---

### 2. 操作说明

#### 2.1 进入与启动
1. 构建后打开生成的宿主页面（默认 `dist/index.html` 或你本地的开发服务器页面）。
2. 中央黑色正方形区域即像素棋盘（内部逻辑尺寸经常为 160×160 像素，当前项目以常量映射单元格）。
3. 初次载入即加载一个默认图案（可在 `init_state()` 或 `setup_glider()` 中调整）。

#### 2.2 运行 / 暂停
- 点击“暂停 / 继续”按钮或按键盘空格键 `Space`。  
- 暂停时允许编辑棋盘；运行时只能观察演化。

#### 2.3 重置 & 清空
- “重置”：恢复到初始种子（调用初始化逻辑同时清空代数计数）。对应按键 `R`。  
- “清空”：将所有细胞置为死亡并保持当前暂停状态（当前实现里复用 `R` 逻辑 + 状态控制；后续可独立映射）。

#### 2.4 编辑棋盘
- 暂停状态下：鼠标左键点击单元格以“切换”该细胞生死。  
- 按住拖动：连续绘制同一状态（内部通过 `drag_value` 和 `has_cell_changed` 进行去抖 / 防重复写入）。  
- 悬停高亮：光标所在格会描边提示（通过 `draw_hover()` 计算坐标并绘制）。

#### 2.5 代数与节奏
- 程序使用 `update_interval`（常量）控制演化节奏（例如每 N 帧演化一次），在 `simulation.mbt::update_simulation()` 中统计 `tick_counter`。  
- 代数（`generation`）计数在每次成功演化后自增。

#### 2.6 可用按键（桌面）
| 功能 | 按键 |
|------|------|
| 运行 / 暂停 | Space |
| 重置 | R |
| 清空（当前同重置或组合策略） | （预留，可扩展为 X 或自定义） |
| 鼠标编辑 | 左键（暂停时） |

#### 2.7 触控设备
- WASM‑4 运行时可能自动出现虚拟十字键 + 2 个按钮；本项目主要使用键盘 / 鼠标，虚拟手柄非必需，可后续移除。  
- 若播放音频或监听键事件受限，可多次点画布激活焦点（运行时代码会尝试 unlock audio）。

#### 2.8 推荐实验步骤
1. 暂停 -> 清空；  
2. 放置一个“L”形的 3 格，继续，观察是否生成滑翔机；  
3. 复位，通过复制 / 平移多个滑翔机测试相互作用；  
4. 调整 `update_interval` 体验快/慢演化。  
5. 添加自定义初始结构函数（仿照 `setup_glider()`）。

---

### 3. 技术特色与实现细节

| 模块 | 作用 | 技术要点 |
|------|------|----------|
| `constants.mbt` | 全局常量（网格尺寸、间距、更新周期等） | 改一处，全局布局/节奏联动；利于后期调参 |
| `game_of_life.mbt` | 细胞数据结构与规则演化 | 使用二维到一维索引映射；双缓冲（当前代 -> 复制 / 或就地）避免读写冲突；邻居计数循环优化 |
| `game_state.mbt` | 运行态：代数、运行标志、拖拽状态、上一输入 | 明确区分“纯逻辑状态”与“渲染/输入” |
| `input_handler.mbt` | 手柄 / 鼠标输入映射为状态变更 | 拆分 mouse drag 与 click，避免多次写；记录上一次单元格位置降低重复写入 |
| `simulation.mbt` | Tick 节流与演化调度 | 用计数器而非精确时间，保证确定性（帧驱动） |
| `renderer.mbt` | 绘制背景、网格、活细胞与悬浮高亮 | 只消费只读数据，不改状态；分函数易扩展主题 / 皮肤 |
| `cartridge.mbt` | 汇聚生命周期入口 | 桥接 WASM‑4 的 `start/update` 到项目内部管线 |
| `main.mbt` | 导出 MoonBit -> WASM‑4 必需符号 | 与 `moon.pkg.json` 的 export 对应 |

#### 3.1 演化规则实现
- 标准生命游戏规则 B3/S23：
	- 任何活细胞若存活邻居 <2：死亡（孤独）
	- 存活邻居为 2 或 3：保持生存
	- >3：死亡（过度拥挤）
	- 死细胞若恰好有 3 个存活邻居：诞生
- 计数函数 `count_neighbors` 遍历 8 邻域；可进一步：
	- 用预计算行偏移 / LUT 加速；
	- 或用 bitset + 位运算批量并行（将来优化空间）。

#### 3.2 双缓冲 / 原地策略
当前版本保持清晰逻辑优先：生成下一代时使用新数组（或逻辑分支），避免在迭代中污染邻居读取；MoonBit 编译到 WASM 后，小数组拷贝成本可接受。后续可切入：奇偶帧翻转索引、位打包压缩（64 位块）提升缓存命中率。

#### 3.3 输入去抖
- `has_cell_changed(last_cell_x, last_cell_y, current_x, current_y)` 防止同格重复 toggle。  
- 拖拽时记录 `drag_value`（最初 toggle 后的目标状态），后续拖动写入同一值，而不是再次 toggle，形成“刷子”体验。

#### 3.4 渲染层
- 仅使用 WASM‑4 原生 API（像素/线/矩形等），保持无第三方依赖。  
- 栅格与背景分离，使得更换调色板、添加热图（根据细胞生命时长）可在 renderer 内独立进行。  
- 悬停高亮通过计算鼠标坐标 -> 网格坐标 -> 边框绘制。

#### 3.5 性能与确定性
- 固定帧 tick + 离散步进 -> 万次回放仍 deterministic。  
- 若未来引入可变速：保持逻辑步长 discrete，渲染插帧即可。  
- 结构拆分方便做基准：可为 `count_neighbors`、`update` 单独写 micro benchmark。

#### 3.6 MoonBit 语言亮点使用
- 模块化：每个 `.mbt` 文件拆分关注点，接口清晰，`.mbti` 生成证明对外可见接口稳定。  
- 强类型 + 简洁语法提升演化与渲染函数的可读性。  
- WASM 目标产物体积小，适合嵌入 WASM‑4。  
- 编译后易与 JS 宿主页面集成（`bundle` 生成 `cart.html`）。

#### 3.7 可扩展路线（留档）
- [ ] 多种规则集（HighLife / Seeds / Day & Night）切换。  
- [ ] 预置模式库：RLE 格式解析导入。  
- [ ] 统计面板：活细胞数、稳定检测、周期长度探测。  
- [ ] 彩色龄（age coloring）：细胞存活越久色相变化。  
- [ ] 交互框选复制 / 粘贴。  
- [ ] 多线程（Web Worker + OffscreenCanvas）渲染分离（视规模再评估）。

---

### 4. 构建与运行（用户视角）

> 以下命令仅说明流程，实际脚本名称与路径以仓库 `package.json` 为准。

#### 4.1 构建
```bash
bun run build      # 生成 wasm（wasm-gc 目标）
bun run bundle     # 调用 wasm4 bundle，生成 dist/cart.html + index.html
```

#### 4.2 本地预览
- 用静态服务器打开 `dist/`；或若已在脚本里提供 `dev`，执行：
```bash
bun run dev
```
访问输出的本地地址即可。

#### 4.3 修改调参与再次运行
1. 改 `src/constants.mbt` 中尺寸与 `update_interval`；  
2. 重新 `bun run build && bun run bundle`；  
3. 刷新宿主页面。

#### 4.4 常见问题
| 问题 | 可能原因 | 解决 |
|------|----------|------|
| 构建成功但页面无反应 | 未调用 `start` 或 `upd` 导出异常 | 检查 `moon.pkg.json` exports 匹配 `main.mbt` |
| 鼠标无法编辑 | 当前仍在运行状态 | 先暂停再编辑 |
| 虚拟手柄遮挡 | WASM‑4 运行时自动插入触控覆层 | 可在宿主注入样式隐藏（后续文档可加） |

---

### 5. 团队信息

| 项 | 信息 |
|----|------|
| 团队名称 | （填写你的团队名，例如：MoonLife Lab） |
| 成员 | （示例）张三 / 李四 / … |
| 分工 | 架构 & 演化逻辑 / 渲染 & UI / 构建脚本 / 文档等 |
| 联系方式 | 邮箱：example@example.com （或 GitHub / 其他） |
| 仓库地址 | https://github.com/xingwangzhe/Game_of_Life |

> 若为个人作品，可将“团队名称”与“成员”写成个人 ID，并保留联系方式。

---

### 6. License（可选）
当前仓库根 README 尚未注明许可证。建议：
- 若希望开放学习：MIT / Apache-2.0；
- 若保留衍生约束：GPL-3.0；
- 或添加 `LICENSE` 文件后在此处补充。

---

### 7. 版本与变更记录（建议起始）
| 版本 | 日期 | 说明 |
|------|------|------|
| 0.1.0 | 2025-10-04 | 初始公开版本，基础演化 + 编辑 + 网格渲染 |
| 0.1.1 | （待填） | 优化渲染 / 新增清空独立键 / …… |

> 后续在每次提交重要功能后更新此表，便于评审/协作。

---

### 8. 后续改进优先级建议（参考）
1. 独立“清空”键 & UI 提示状态（正在运行 / 暂停 / 代数）。  
2. 模式预设按钮（快速插入 Glider / Pulsar / Gun）。  
3. Age 颜色渐变（提升可视分析）。  
4. RLE 导入导出（与外部模式社区兼容）。  
5. 性能 profiling + 位压缩（大尺寸棋盘性能提升）。

---

感谢阅读，欢迎提出 Issue / PR 改进本示例！

