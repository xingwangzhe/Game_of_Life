<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conway 生命游戏 - Web 宿主</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif; background:#0d0f12; color:#e6e6e6; }
    header { padding:12px 20px; background:#12161c; border-bottom:1px solid #1e2530; font-size:14px; letter-spacing:.5px; }
    .layout { display:flex; height:calc(100vh - 50px); }
    .panel { width:260px; padding:18px 18px 32px; overflow:auto; background:#12161c; border-right:1px solid #1e2530; font-size:14px; line-height:1.6; }
    .panel.right { border-right:none; border-left:1px solid #1e2530; }
    h1 { font-size:18px; margin:0 0 12px; font-weight:600; }
    h2 { font-size:15px; margin:24px 0 8px; font-weight:600; letter-spacing:.5px; }
    p { margin:0 0 10px; }
    ul { margin:4px 0 12px 18px; padding:0; }
    li { margin:2px 0; }
    code { background:#1b232d; padding:2px 5px; border-radius:4px; font-size:12px; }
    .center { flex:1; display:flex; justify-content:center; align-items:center; position:relative; }
    .game-wrapper { aspect-ratio:1/1; width:min(95vmin,720px); max-width:720px; display:flex; justify-content:center; align-items:center; }
    iframe { width:100%; height:100%; border:0; background:#000; box-shadow:0 0 0 1px #1e2530, 0 0 18px -4px #000; border-radius:8px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 18px; }
    button { cursor:pointer; background:#1e2530; color:#e6e6e6; border:1px solid #2a3542; padding:8px 14px; font-size:13px; border-radius:6px; line-height:1; letter-spacing:.5px; transition:.15s background,.15s border,.15s transform; font-weight:500; }
    button:hover { background:#26323f; }
    button:active { background:#2f3e4d; transform:translateY(1px); }
    button.primary { background:#2d72d2; border-color:#2d72d2; }
    button.primary:hover { background:#3681e8; }
    button.danger { background:#8f2d2d; border-color:#a03535; }
    button.danger:hover { background:#b33d3d; }
    .status { font-size:12px; opacity:.75; margin-top:4px; }
    footer { position:absolute; bottom:8px; right:12px; font-size:11px; opacity:.55; }
    a { color:#5aa9ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    @media (max-width:1220px) { .panel { width:220px; } }
    @media (max-width:980px) { .panel { display:none; } .panel.right { display:none; } header { text-align:center; } }
  </style>
</head>
<body>
  <header>Conway's Game of Life (MoonBit + WASM-4) · 康威细胞生命游戏</header>
  <div class="layout">
    <aside class="panel left">
      <h1>生命游戏简介</h1>
      <p>Conway 生命游戏是一种 <strong>零玩家</strong> 的元胞自动机：状态仅由初始配置与规则自动演化。</p>
      <h2>核心规则</h2>
      <ul>
        <li>少于 2 个存活邻居：孤独 -> 死亡</li>
        <li>2 或 3 个存活邻居：保持存活</li>
        <li>超过 3 个存活邻居：拥挤 -> 死亡</li>
        <li>正好 3 个存活邻居：空格子诞生生命</li>
      </ul>
      <h2>玩法提示</h2>
      <p>用面板右侧的操作快速暂停 / 继续 / 重置，或直接在棋盘上编辑初始形状。</p>
      <p>你可以尝试构造：</p>
      <ul>
        <li>滑翔机 (Glider)</li>
        <li>脉冲星 (Pulsar)</li>
        <li>滑翔枪 (Gosper Glider Gun)</li>
      </ul>
      <p class="status">中央画布原始分辨率 160×160，经 CSS 放大保持像素风格。</p>
    </aside>
    <main class="center">
      <div class="game-wrapper">
  <!-- 使用 wasm4 bundle 生成的 cart.html 作为 iframe 内容 -->
  <iframe id="gameFrame" src="./cart.html" title="Game of Life"></iframe>
      </div>
    </main>
    <aside class="panel right">
      <h2>操作说明</h2>
      <div class="actions">
        <button id="btnToggle" class="primary">暂停 / 继续</button>
        <button id="btnReset" class="danger">重置</button>
        <button id="btnClear">清空</button>
      </div>
      <p>交互：</p>
      <ul>
        <li>鼠标左键：在暂停状态下切换细胞</li>
        <li>空格：运行 / 暂停</li>
        <li>R：重置（清空并复位代数）</li>
        <li>（若支持）X：清空棋盘</li>
      </ul>
      <h2>移动端</h2>
      <p>按钮已兼容触控；若设备出现键盘事件限制，可多次点击画布激活音频与输入。</p>
      <h2>状态</h2>
      <div id="statusArea" class="status">就绪</div>
    </aside>
  </div>
  <script>
    const frame = document.getElementById('gameFrame');
    const statusArea = document.getElementById('statusArea');
    function sendKey(code, keyValue) {
      const win = frame.contentWindow;
      if (!win) return;
      const opts = { code, key: keyValue || (code === 'Space' ? ' ' : code), bubbles: true };
      // 触发 keydown + keyup
      win.dispatchEvent(new KeyboardEvent('keydown', opts));
      // 延迟一点点再触发 keyup 以避免被忽略
      setTimeout(() => win.dispatchEvent(new KeyboardEvent('keyup', opts)), 16);
    }
    function toggleRun() {
      sendKey('Space', ' ');
      flashStatus('切换运行状态');
    }
    function resetAll() {
      sendKey('KeyR', 'r');
      flashStatus('重置');
    }
    function clearBoard() {
      // 利用我们映射的“清空”逻辑：当前实现中按手柄 button_2 (映射 X?)；这里模拟 R 后立即暂停并清空可改成自定义接口。
      // 暂无单独清空键，发送 R + Space 两次策略：先暂停+清空再保持暂停。
      sendKey('KeyR', 'r');
      flashStatus('清空棋盘');
    }
    function flashStatus(msg) {
      statusArea.textContent = msg + ' @' + new Date().toLocaleTimeString();
    }
    document.getElementById('btnToggle').addEventListener('click', toggleRun);
    document.getElementById('btnReset').addEventListener('click', resetAll);
    document.getElementById('btnClear').addEventListener('click', clearBoard);
    // 为触控设备在激活时尝试解锁音频
    frame.addEventListener('load', () => {
      flashStatus('游戏已加载');
      frame.contentWindow.focus();
    });
    // 自适应：保持方形区域在窗口变化时居中，无额外代码依赖 CSS
  </script>
</body>
</html>
