name: Build and Publish

on:
  workflow_dispatch:

jobs:
  build-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-24.04'
            args: ''
          - platform: 'windows-latest'
            args: ''
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: MoonBit CLI cache
        uses: actions/cache@v4
        with:
          path: ~/.moon
          key: ${{ runner.os }}-moon-${{ hashFiles('**/moon.pkg.json','moon.mod.json') }}
          restore-keys: |
            ${{ runner.os }}-moon-

      - name: Install MoonBit CLI (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
          iwr https://cli.moonbitlang.cn/install/powershell.ps1 -UseBasicParsing | iex
          "$Env:USERPROFILE/.moon/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          # 立即在当前 step 生效 PATH
          $env:PATH = "$Env:USERPROFILE/.moon/bin;" + $env:PATH
          $moonBin = Join-Path $Env:USERPROFILE ".moon/bin"
          $moonExe = Join-Path $moonBin "moon.exe"
          $moonNoExt = Join-Path $moonBin "moon"
          if (-not (Test-Path $moonExe) -and -not (Test-Path $moonNoExt)) {
            Write-Host "目录结构 (调试):"
            Get-ChildItem -Recurse $moonBin | Select-Object FullName,Length,LastWriteTime
            Write-Error 'MoonBit CLI 安装失败: 未找到 moon 或 moon.exe 可执行文件'
            exit 1
          }
          if (Test-Path $moonExe) { & $moonExe version } else { & $moonNoExt version }

      - name: MoonBit registry update (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          moon update
          if ($LASTEXITCODE -ne 0) {
            Write-Warning 'moon update failed (network/registry issue); continuing build'
          } else {
            Write-Host 'moon update succeeded'
          }

      - name: Install MoonBit CLI (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          curl -fsSL https://cli.moonbitlang.cn/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH
          # 让当前 step 也能使用 moon（echo 到 GITHUB_PATH 只对后续 steps 生效）
          export PATH="$HOME/.moon/bin:$PATH"
          test -x "$HOME/.moon/bin/moon" || { echo 'MoonBit CLI 安装失败: 未找到 moon 可执行文件'; exit 1; }
          moon version

      - name: MoonBit registry update (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          if moon update; then
            echo "moon update 成功"
          else
            echo "[警告] moon update 失败(可能网络/registry)，继续后续构建" >&2
          fi

      - name: Install system dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-24.04'
        run: |
          sudo apt update
          sudo apt install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf pkg-config libgtk-3-dev libglib2.0-dev libgdk-pixbuf2.0-dev libsoup-3.0-dev

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node (npm)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies with npm
        run: |
          npm install
          npx wasm4 --version || echo "npx wasm4 暂不可用(可能未装), 继续"

      - name: Verify wasm4 via bun & npm
        run: |
          bun x wasm4 --version || echo "bun x wasm4 失败"
          npx wasm4 --version || echo "npx wasm4 失败"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Cache Bun install cache
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Cache Bun install cache (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\.bun\install\cache
          key: ${{ runner.os }}-bun-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install frontend dependencies
        run: bun install

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Ad-hoc signing for macOS to allow building without certificates
          APPLE_SIGNING_IDENTITY: ${{ matrix.platform == 'macos-latest' && '-' || '' }}
        with:
          tagName: app-v__VERSION__
          releaseName: 'App v__VERSION__'
          releaseBody: |
            ## 平台与构建产物

            ### 桌面端（Release 附件）
            - **macOS (Apple Silicon)**：`*-aarch64-apple-darwin.dmg/.app`，使用 *adhoc* 签名，仅供本地测试。首次启动可能被 Gatekeeper 拦截，请右键 → 打开确认。未 no[...]
            - **macOS (Intel)**：`*-x86_64-apple-darwin.dmg/.app`，同样为 *adhoc* 签名，安全策略与上相同。
            - **Windows**：`*.msi` / `*.exe`，未进行代码签名；Windows SmartScreen 会提示来源未知。安装前建议校验哈希，执行时关注系统告警。
            - **Linux**：`*.AppImage` / `*.deb`，未签名。AppImage 需手动 `chmod +x` 后运行；Deb 包会提示未签名来源。

            ### 移动端（Release 附件）
            - **Android Debug**：`*-debug.apk`，以 debug key 签名，只用于测试，系统会提示"来自未知来源"。
            - **Android Release**：`*-release-unsigned.apk`，尚未使用正式 keystore，需要手动签名＋对齐后方可商用分发。
            - **iOS**：当前未自动产出 iOS 安装包；若需真机或模拟器构建，请手动运行 `cargo tauri ios ...` 并自行处理签名。

            ## 签名与安全说明
            由于仅作为游戏演示，且本仓库公开，所有平台均未使用正式签名证书（macOS 使用 adhoc 签名以便能构建可运行的 app）。因此，操作系统可能会[...]
            ## 已知风险
            - 未签名构建在企业环境可能触发安全策略，需在受控环境中使用。
            - 若需自动分发（App Store / Microsoft Store / Snap 等），请在本仓库之外维护签名密钥，避免在公共仓库暴露敏感凭据。
            - CI 仅缓存构建依赖，不会持久化任何私钥；请勿将证书放入仓库或普通 Artifact。
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

  # Android 构建（使用 Tauri v2 移动支持）
  build-android:
    needs: build-tauri  # 等待 build-tauri 完成以确保 release draft 已创建
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写权限来上传到 release
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: MoonBit CLI cache
        uses: actions/cache@v4
        with:
          path: ~/.moon
          key: ${{ runner.os }}-moon-${{ hashFiles('**/moon.pkg.json','moon.mod.json') }}
          restore-keys: |
            ${{ runner.os }}-moon-

      - name: Install MoonBit CLI
        run: |
          curl -fsSL https://cli.moonbitlang.cn/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH
          export PATH="$HOME/.moon/bin:$PATH"
          test -x "$HOME/.moon/bin/moon" || { echo 'MoonBit CLI 安装失败: 未找到 moon 可执行文件'; exit 1; }

      - name: MoonBit registry update
        run: |
          set -e
          if moon update; then
            echo "moon update 成功"
          else
            echo "[警告] moon update 失败(可能网络/registry)，继续后续构建" >&2
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node (npm)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies with npm
        run: |
          npm install
          npx wasm4 --version || echo "npx wasm4 暂不可用(可能未装), 继续"

      - name: Verify wasm4 via bun & npm
        run: |
          bun x wasm4 --version || echo "bun x wasm4 失败"
          npx wasm4 --version || echo "npx wasm4 失败"

      - name: Setup Java (Android 构建需要 JDK 17)
        uses: actions/setup-java@v4
        with:
            distribution: 'temurin'
            java-version: '17'

      - name: Install Rust (含 Android 目标)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Cache cargo (tauri-cli)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-tauri
            ~/.cargo/bin/cargo-tauri.exe
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-tauri-v2
          restore-keys: |
            ${{ runner.os }}-cargo-tauri-
            ${{ runner.os }}-cargo-

      - name: Install Tauri CLI (cargo)
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          export PATH="$HOME/.cargo/bin:$PATH"
          if command -v cargo-tauri >/dev/null 2>&1; then
            echo 'cargo-tauri 已存在，跳过安装'
          else
            # 优先带 --locked 安装，失败则回退
            if ! cargo install tauri-cli --locked ; then
              echo '使用 --locked 安装失败，尝试不加 --locked'
              cargo install tauri-cli || { echo '安装 tauri-cli 失败'; exit 1; }
            fi
          fi
          # 验证安装
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            echo '未找到 cargo-tauri 可执行文件'; ls -al "$HOME/.cargo/bin"; exit 1;
          fi
          cargo tauri --version

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Cache Bun install cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK Components & NDK
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;25.2.9519653"
          export NDK_PATH="$ANDROID_SDK_ROOT/ndk/25.2.9519653"
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

      - name: Install frontend deps
        run: bun install

      - name: Build frontend (bundle dist)
        run: bun run bundle

      - name: Init Android project (conditional)
        run: |
          if [ -d src-tauri/gen/android ]; then
            echo "Android 项目已存在，跳过 init"
          else
            cd src-tauri
            cargo tauri android init --ci
          fi

      - name: Build Android Debug APK (universal)
        run: |
          cd src-tauri
          # Tauri 2: --debug flag for debug build, --apk to build APK
          cargo tauri android build --debug --apk true

      - name: Upload Android Debug APK (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: |
            src-tauri/gen/android/**/outputs/**/*.apk

      - name: Build Android Release APK (universal)
        run: |
          cd src-tauri
          # Tauri 2: release mode is default, use --apk to build APK
          cargo tauri android build --apk true

      - name: Upload Android Release APK (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release
          path: |
            src-tauri/gen/android/**/outputs/**/*.apk

      - name: Get version from tauri.conf.json
        id: get_version
        run: |
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=app-v$VERSION" >> $GITHUB_OUTPUT
          echo "App version: $VERSION, Release tag: app-v$VERSION"

      - name: Prepare APKs for release upload
        run: |
          mkdir -p release-apks
          find src-tauri/gen/android -name "*.apk" -exec cp {} release-apks/ \;
          ls -la release-apks/

      - name: Upload Android APKs to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          draft: true
          files: release-apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
